using SG_Tool.Log;
using Amazon;
using Amazon.ECS;
using Amazon.ECS.Model;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;

namespace SG_Tool.L9_Tool.AWS
{
    public class EcsPatch_Live_Form : UserControl
    {
        AmazonECSClient m_ecsClient;
        bool m_bSetting = false;
        Button m_btnUpdateImage = null!;
        Button m_btnUpdateAll = null!;
        Button m_btnECS_Off = null!;
        Button m_btnECS_On = null!;

        bool m_bEditingImage = false;
        bool m_bEditingCount = false;

        TextBox m_txtLog = null!;
        TableLayoutPanel m_checkBoxPanel = null!;
        CancellationTokenSource m_statusCts = null;
        Dictionary<EcsDataEnum, EcsData> m_dicecsData = new Dictionary<EcsDataEnum, EcsData>();
        string m_strConfigFile = $@"L9\L9_LiveData.cfg";
        Dictionary<L9DataType, string> m_dicData = new Dictionary<L9DataType, string>();
        Dictionary<EcsDataEnum, TextBox[]> m_dicParameters = new Dictionary<EcsDataEnum, TextBox[]>();
        EnLoad9_Type m_enLoad9_Type;
        public EcsPatch_Live_Form (EnLoad9_Type enLoad9_Type)
        {
            m_enLoad9_Type = enLoad9_Type;
            m_strConfigFile = $@"{enLoad9_Type}\L9_LiveData.cfg";
            InitializeUI();
        }

        void InitializeUI()
        {
            SG_Common.Log(m_txtLog, $"‚úÖ InitializeUI");
            m_bSetting = SG_Common.SetPatchL9Data(m_strConfigFile, m_dicData);
            BackColor = Color.LightCyan;

            // ÏÉÅÎã® Î≤ÑÌäº Î∞è ÌååÎùºÎØ∏ÌÑ∞ ÏòÅÏó≠
            var topPanel = new FlowLayoutPanel
            {
                FlowDirection = FlowDirection.LeftToRight,
                Dock = DockStyle.Top,
                Padding = new Padding(5),
                AutoSize = true,
                //BackColor = Color.LightCyan
                BackColor = m_enLoad9_Type == EnLoad9_Type.L9 ? Color.LightCyan : Color.LightPink
            };

            m_btnUpdateImage = SG_Common.GetButton("Update Image", Color.AliceBlue);
            m_btnUpdateAll = SG_Common.GetButton("Update ECS", Color.AliceBlue);
            m_btnECS_Off = SG_Common.GetButton("ECS Off", Color.AliceBlue);
            m_btnECS_On = SG_Common.GetButton("ECS On", Color.AliceBlue);

            m_btnUpdateImage.Click += UpdateImage_Click;
            m_btnUpdateAll.Click += UpdateService_Click;
            m_btnECS_Off.Click += ECS_Off_Click;
            m_btnECS_On.Click += ECS_On_Click;

            var ecsButtonPanel = new FlowLayoutPanel
            {
                FlowDirection = FlowDirection.TopDown,   // ÏàòÏßÅ Ï†ïÎ†¨
                Anchor = AnchorStyles.Left,
                AutoSize = true,
                Margin = new Padding(5, 6, 5, 0), // ÎÜíÏù¥Ïóê Îî∞Îùº Ï°∞Ï†à (Ïòà: 6)
            };
            ecsButtonPanel.Controls.AddRange(new Control[] { m_btnUpdateAll, m_btnECS_Off, m_btnECS_On });

            m_checkBoxPanel = new TableLayoutPanel
            {
                Width = 500,
                Height = 180,
                Margin = new Padding(5),
                AutoScroll = true,
                Anchor = AnchorStyles.Top | AnchorStyles.Right
            };

            // ÏÉÅÎã®Ïóê Î∞∞ÏπòÌï† Ïª®Ìä∏Î°§ Íµ¨ÏÑ±
            topPanel.Controls.Add(m_btnUpdateImage);
            topPanel.Controls.Add(ecsButtonPanel); // Ïó¨Í∏∞Ïóê ECS Î≤ÑÌäº Î¨∂ÏùÄ Ìå®ÎÑê Ï∂îÍ∞Ä
            topPanel.Controls.Add(m_checkBoxPanel);

            // Î°úÍ∑∏ ÏòÅÏó≠
            m_txtLog = new TextBox
            {
                Multiline = true,
                ScrollBars = ScrollBars.Vertical,
                Font = new Font("Consolas", 9),
                Dock = DockStyle.Fill,
                Margin = new Padding(10),
                ReadOnly = true,
                TabStop = false,
                BorderStyle = BorderStyle.FixedSingle,
                BackColor = SystemColors.Window
            };

            // Î©îÏù∏ Ìå®ÎÑê Íµ¨ÏÑ±
            var mainPanel = new TableLayoutPanel
            {
                Dock = DockStyle.Fill,
                RowCount = 2,
                ColumnCount = 1
            };
            mainPanel.RowStyles.Add(new RowStyle(SizeType.AutoSize));
            mainPanel.RowStyles.Add(new RowStyle(SizeType.Percent, 60F));

            mainPanel.Controls.Add(topPanel, 0, 0);
            mainPanel.Controls.Add(m_txtLog, 0, 1);

            Controls.Add(mainPanel);
            LoadServerList();
        }

        void LoadServerList()
        {
            string strServerPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "L9", "L9_Live.cfg");
            m_bEditingImage = false;
            m_bEditingCount = false;
            m_checkBoxPanel.Controls.Clear();
            m_dicParameters.Clear();
            m_dicecsData.Clear();

            // ===========================================================
            // ÏßÄÏó≠ÏùÄ ÌïÑÏöî Ïãú ÏÑ§Ï†ï
            var config = new AmazonECSConfig
            {
                RegionEndpoint = m_enLoad9_Type == EnLoad9_Type.L9 ? RegionEndpoint.APNortheast1 :RegionEndpoint.APEast1 // ÎèÑÏøÑÎ¶¨Ï†Ñ : ÌôçÏΩ©Î¶¨Ï†Ñ
            };

            // AWS ÏûêÍ≤© Ï¶ùÎ™Ö ÏÑ§Ï†ï
            //SystemLog_Form.LogMessage(m_txtLog, $"[LoadServerList()] AwsAccessKey : {m_dicData[L9DataType.AwsAccessKey]}, AwsSecretKey : {m_dicData[L9DataType.AwsSecretKey]}");
            m_ecsClient = new AmazonECSClient(m_dicData[L9DataType.AwsAccessKey], m_dicData[L9DataType.AwsSecretKey], config);
            // ===========================================================

            if (File.Exists(strServerPath))
            {
                SG_Common.Log(m_txtLog, $"‚úÖ Live AWS ECS Load Start");
                List<TextBox> imageBoxlist = new List<TextBox>();
                List<TextBox> countBoxlist = new List<TextBox>();
                List<Label> statusLabellist = new List<Label>();
                List<EcsData> ecsDatalist = new List<EcsData>();

                var lines = File.ReadAllLines(strServerPath);
                foreach (var line in lines)
                {
                    if (line.StartsWith("#")) continue; // Ï£ºÏÑù Ï†úÏô∏.

                    var parts = line.Split(' ');
                    if (parts.Length != 5)
                    {
                        SG_Common.Log(m_txtLog, $"‚úÖ LoadServerList : {strServerPath} ÌååÏùº ÌôïÏù∏ ÌååÎùºÎØ∏ÌÑ∞ Î∂ÄÏ°±.");
                        continue;
                    }

                    EcsData ecsData = new EcsData(parts[0], parts[1], parts[2], parts[3], int.Parse(parts[4]));

                    var checkBox = new CheckBox
                    {
                        Text = ecsData.Tag,
                        AutoSize = true,
                        Checked = ecsData.Tag == "log"? false : true
                    };

                    var imageBox = new TextBox
                    {
                        Width = 180,
                        Text = "0000_00_00_0",
                        ForeColor = Color.Black,
                        TextAlign = HorizontalAlignment.Left,
                        Anchor = AnchorStyles.Top | AnchorStyles.Right
                    };
                    imageBox.Enter += (s, e) => m_bEditingImage = true;

                    var countBox = new TextBox
                    {
                        Width = 40,
                        Text = "00",
                        ForeColor = Color.Black,
                        TextAlign = HorizontalAlignment.Center,
                        Anchor = AnchorStyles.Top | AnchorStyles.Right
                    };
                    countBox.Enter += (s, e) => m_bEditingCount = true;

                    var statusLabel = new Label
                    {
                        Text = "ÏÑúÎπÑÏä§ Ï†ïÎ≥¥ ÏóÜÏùå",
                        AutoSize = true,
                        TextAlign = ContentAlignment.MiddleCenter,
                        Anchor = AnchorStyles.Left
                    };

                    var panel = new TableLayoutPanel
                    {
                        ColumnCount = 4,
                        AutoSize = true,
                        CellBorderStyle = TableLayoutPanelCellBorderStyle.None,
                        Margin = new Padding(2)
                    };


                    // Ïó¥ ÎπÑÏú® ÎòêÎäî Í≥†Ï†ï Ìè≠ ÏÑ§Ï†ï
                    panel.ColumnStyles.Add(new ColumnStyle(SizeType.Absolute, 80));  // CheckBox (Tag)
                    panel.ColumnStyles.Add(new ColumnStyle(SizeType.Absolute, 180)); // ImageTag TextBox
                    panel.ColumnStyles.Add(new ColumnStyle(SizeType.Absolute, 40));  // Count TextBox
                    panel.ColumnStyles.Add(new ColumnStyle(SizeType.Absolute, 300));  // Count TextBox

                    panel.Controls.Add(checkBox, 0, 0);
                    panel.Controls.Add(imageBox, 1, 0);
                    panel.Controls.Add(countBox, 2, 0);
                    panel.Controls.Add(statusLabel, 3, 0);

                    m_checkBoxPanel.Controls.Add(panel);
                    if (Enum.TryParse<EcsDataEnum>(ecsData.Tag, out var enumKey))
                    {
                        m_dicParameters.Add(enumKey, new TextBox[] { imageBox, countBox });
                        m_dicecsData.Add(enumKey, ecsData);
                    }

                    imageBoxlist.Add(imageBox);
                    countBoxlist.Add(countBox);
                    statusLabellist.Add(statusLabel);
                    ecsDatalist.Add(ecsData);
                }
                StartUpdateStatus(imageBoxlist, countBoxlist, statusLabellist, ecsDatalist);
            }
        }

        void StartUpdateStatus(List<TextBox> imageBox, List<TextBox> countBox, List<Label> statusLabel, List<EcsData> ecsData)
        {
            // Ïù¥Ï†Ñ ÏûëÏóÖÏù¥ Ïã§Ìñâ Ï§ëÏù¥ÎùºÎ©¥ Ï∑®ÏÜå
            if (m_statusCts != null)
            {
                SystemLog_Form.LogMessage(m_txtLog, "üîÅ ÏóÖÎç∞Ïù¥Ìä∏ ÏÉÅÌÉú ÎåÄÏÉÅ Î≥ÄÍ≤Ω.");
                m_statusCts.Cancel();     // Ïù¥Ï†Ñ ÏûëÏóÖ ÏöîÏ≤≠ Ï§ëÎã®
                m_statusCts.Dispose();
            }

            m_statusCts = new CancellationTokenSource();
            var token = m_statusCts.Token;

            // ÏÉàÎ°≠Í≤å ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë
            _ = UpdateStatusAsync(imageBox, countBox, statusLabel, ecsData, token);
        }

        async System.Threading.Tasks.Task UpdateStatusAsync(List<TextBox> imageBoxlist, List<TextBox> countBoxlist, List<Label> statusLabellist, List<EcsData> ecsDatalist, CancellationToken token)
        {
            //int nCount = 0;
            while (!token.IsCancellationRequested)
            {
                try
                {
                    if (token.IsCancellationRequested) break;
                    if (m_ecsClient == null) return;

                    SG_Common.Log(m_txtLog, $"[UpdateStatusAsync] Live ECS Start");

                    for (int i = 0; i < ecsDatalist.Count; i++)
                    {
                        var ecsData = ecsDatalist[i];
                        var imageBox = imageBoxlist[i];
                        var countBox = countBoxlist[i];
                        var statusLabel = statusLabellist[i];

                        //SG_Common.Log(m_txtLog, $"[UpdateStatusAsync] Cluster : {ecsData.Cluster} (1)");

                        var describeResponse = await m_ecsClient.DescribeServicesAsync(new DescribeServicesRequest
                        {
                            Cluster = ecsData.Cluster,
                            Services = new List<string> { ecsData.Service }
                        });
                        
                        var taskDefResponse = await m_ecsClient.DescribeTaskDefinitionAsync(new DescribeTaskDefinitionRequest
                        {
                            TaskDefinition = ecsData.Task,
                        });
                        var taskDef = taskDefResponse.TaskDefinition;
                        string imageTag = taskDef.ContainerDefinitions.Count > 0 ? taskDef.ContainerDefinitions[0].Image : "0000_00_00_0";

                        Service serviceDesc = describeResponse.Services.FirstOrDefault();
                        string currentStatus = "ÏÑúÎπÑÏä§ Ï†ïÎ≥¥ ÏóÜÏùå";

                        if (serviceDesc != null)
                        {
                            currentStatus = $"üü¢ {serviceDesc.RunningCount}/{serviceDesc.DesiredCount} Running";
                            if (serviceDesc.PendingCount > 0)
                                currentStatus += $", ‚è≥ {serviceDesc.PendingCount} Pending";

                            if (serviceDesc.Deployments.Count > 1)
                                currentStatus += ", ‚ö†Ô∏è Deploying...";
                        }

                        if (!m_bEditingImage)
                            imageBox.Text = imageTag.Contains(":") ? imageTag.Substring(imageTag.LastIndexOf(":") + 1) : imageTag;

                        if (!m_bEditingCount)
                            countBox.Text = serviceDesc != null ? serviceDesc.DesiredCount.ToString() : "00";

                        statusLabel.Text = currentStatus;
                        statusLabel.ForeColor = currentStatus.Contains("Pending") || currentStatus.Contains("Deploying") ? Color.Red : Color.Green;
                    }

                    // 5Ï¥à ÎåÄÍ∏∞ ÌõÑ Îã§Ïùå ÏÉÅÌÉú ÌôïÏù∏
                    await System.Threading.Tasks.Task.Delay(5000);
                }
                catch (Exception ex)
                {
                    SG_Common.Log(m_txtLog, $"‚ùå [UpdateStatusAsync] Ïò§Î•ò Î∞úÏÉù: {ex.Message}");
                    break;
                }
            }
        }

        void UpdateImage_Click(object sender, EventArgs e)
        {
            if (!m_bSetting)
            {
                SystemLog_Form.LogMessage(m_txtLog, $"cfg ÌååÏùºÏù¥ ÏóÜÏñ¥ Patch_QA ÌôòÍ≤Ω Ïã§Ìñâ Ìï† Ïàò ÏóÜÏäµÎãàÎã§.");
                return;
            }
            UpdateTaskImageTags();
        }

        void UpdateService_Click(object sender, EventArgs e)
        {
            if (!m_bSetting)
            {
                SystemLog_Form.LogMessage(m_txtLog, $"cfg ÌååÏùºÏù¥ ÏóÜÏñ¥ Patch_QA ÌôòÍ≤Ω Ïã§Ìñâ Ìï† Ïàò ÏóÜÏäµÎãàÎã§.");
                return;
            }

            UpdateServiceWithLatestTaskDef();
        }

        void ECS_Off_Click(object sender, EventArgs e)
        {
            if (!m_bSetting)
            {
                SG_Common.Log(m_txtLog, $"cfg ÌååÏùºÏù¥ ÏóÜÏñ¥ Patch_QA ÌôòÍ≤Ω Ïã§Ìñâ Ìï† Ïàò ÏóÜÏäµÎãàÎã§.");
                return;
            }

            SG_Common.UpdateECS(false, m_txtLog, m_ecsClient, m_checkBoxPanel, m_dicecsData);
            m_bEditingImage = false;
            m_bEditingCount = false;
        }

        void ECS_On_Click(object sender, EventArgs e)
        {
            if (!m_bSetting)
            {
                SG_Common.Log(m_txtLog, $"cfg ÌååÏùºÏù¥ ÏóÜÏñ¥ Patch_QA ÌôòÍ≤Ω Ïã§Ìñâ Ìï† Ïàò ÏóÜÏäµÎãàÎã§.");
                return;
            }
            SG_Common.UpdateECS(true, m_txtLog, m_ecsClient, m_checkBoxPanel, m_dicecsData);
            m_bEditingImage = false;
            m_bEditingCount = false;
        }

        async void UpdateTaskImageTags()
        {
            try
            {
                var selectedTags = m_checkBoxPanel.Controls.OfType<TableLayoutPanel>()
                    .SelectMany(panel => panel.Controls.OfType<CheckBox>())
                    .Where(cb => cb.Checked)
                    .Select(cb => cb.Text)
                    .ToList();

                SG_Common.Log(m_txtLog, $"‚úÖ UpdateTaskImageTags(1) {selectedTags.Count}Í∞ú ÏÑ†ÌÉùÎê®");

                foreach (var task in m_dicecsData)
                {
                    if (!selectedTags.Contains(task.Key.ToString())) continue;

                    string newImageTag = m_dicParameters[task.Key][0].Text;
                    SG_Common.Log(m_txtLog, $"‚úÖ UpdateTaskImageTags(2) Key: {task.Key}, newImageTag : {newImageTag}");

                    // 1. Describe Task Definition
                    var taskDefResponse = await m_ecsClient.DescribeTaskDefinitionAsync(new DescribeTaskDefinitionRequest
                    {
                        TaskDefinition = task.Value.Task
                    });

                    TaskDefinition taskDef = taskDefResponse.TaskDefinition;

                    // 2. JSON ÏßÅÎ†¨Ìôî
                    var json = JsonConvert.SerializeObject(taskDef);
                    var jObj = JObject.Parse(json);

                    // 3. Ï†úÍ±∞Ìï¥Ïïº Ìï† ÌïÑÎìú(ÏûêÎèô ÏÉùÏÑ± ÎêòÎäîÍ≤ÉÏúºÎ°ú Ï∂îÏ†ï)
                    var removeKeys = new[]
                    {
                        "TaskDefinitionArn",
                        "Revision",
                        "Status",
                        "RequiresAttributes",
                        "Compatibilities",
                        "RegisteredAt",
                        "RegisteredBy"
                    };

                    foreach (var key in removeKeys)
                        jObj.Remove(key);

                    // 4. Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏Îßå ÏàòÏ†ï
                    var containers = jObj["ContainerDefinitions"];

                    if (containers != null)
                    {
                        //SG_Common.Log(m_txtLog, $"üõ†Ô∏è UpdateTaskImageTags(3) containers ÏàòÎüâ {containers.Count()}");
                        foreach (var container in containers)
                        {
                            //SG_Common.Log(m_txtLog, $"üõ†Ô∏è UpdateTaskImageTags(4) containers {container}");
                            var image = container["Image"]?.ToString();
                            if (!string.IsNullOrEmpty(image))
                            {
                                container["Image"] = SG_Common.UpdateImageTag(image, newImageTag);
                                SG_Common.Log(m_txtLog, $"üõ†Ô∏è {container["Name"]} Ïù¥ÎØ∏ÏßÄ Î≥ÄÍ≤Ω ‚Üí {container["Image"]}");
                            }
                            else
                            {
                                SG_Common.Log(m_txtLog, $"‚ùå {task.Value.Task}  >  {container["Image"]} Ïùò Ïª®ÌÖåÏù¥ÎÑà Ï†ïÏùòÏóêÏÑú Ïù¥ÎØ∏ÏßÄ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
                            }
                        }

                        // 5. JSON ‚Üí RegisterTaskDefinitionRequestÎ°ú Ïó≠ÏßÅÎ†¨Ìôî
                        var registerRequest = new RegisterTaskDefinitionRequest();
                        JsonConvert.PopulateObject(jObj.ToString(), registerRequest);

                        // 6. ÌÉúÏä§ÌÅ¨ Ï†ïÏùò Îì±Î°ù
                        var registerResponse = await m_ecsClient.RegisterTaskDefinitionAsync(registerRequest);
                        SG_Common.Log(m_txtLog, $"‚úÖ ÌÉúÏä§ÌÅ¨ Ï†ïÏùò {task.Value.Task} ‚Üí TaskDefinitionArn : {registerResponse.TaskDefinition.TaskDefinitionArn} Î°ú Îì±Î°ùÎê®");
                    }
                    else
                    {
                        SG_Common.Log(m_txtLog, $"‚ùå {task.Value.Task} Ïùò Ïª®ÌÖåÏù¥ÎÑà Ï†ïÏùòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
                        continue;
                    }
                }

                m_bEditingImage = false;
            }
            catch (Exception ex)
            {
                SG_Common.Log(m_txtLog, $"‚ùå UpdateTaskImageTags() Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò Î∞úÏÉù: {ex.Message}");
            }


        }

        // Í∏∞Îä• 2: ÌÉúÏä§ÌÅ¨ Ï†ïÏùò ÏµúÏã†Ìôî Î∞è ÌÉúÏä§ÌÅ¨ Ïàò Ï°∞Ï†ï
        async void UpdateServiceWithLatestTaskDef()
        {
            var selectedTags = m_checkBoxPanel.Controls.OfType<TableLayoutPanel>()
                .SelectMany(panel => panel.Controls.OfType<CheckBox>())
                .Where(cb => cb.Checked)
                .Select(cb => cb.Text)
                .ToList();

            SG_Common.Log(m_txtLog, $"UpdateServiceWithLatestTaskDef {selectedTags.Count}Í∞ú ÏÑ†ÌÉùÎê®");

            foreach (var task in m_dicecsData)
            {
                if (!selectedTags.Contains(task.Key.ToString())) continue;

                var taskDefs = await m_ecsClient.ListTaskDefinitionsAsync(new ListTaskDefinitionsRequest
                {
                    FamilyPrefix = task.Value.Task,
                    Sort = Amazon.ECS.SortOrder.DESC
                });

                var latestTaskDefArn = taskDefs.TaskDefinitionArns.FirstOrDefault();
                if (latestTaskDefArn == null)
                {
                    MessageBox.Show("‚ùå ÏµúÏã† ÌÉúÏä§ÌÅ¨ Ï†ïÏùòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
                    return;
                }

                int desiredCount = int.Parse(m_dicParameters[task.Key][1].Text);
                await m_ecsClient.UpdateServiceAsync(new UpdateServiceRequest
                {
                    Cluster = task.Value.Cluster,
                    Service = task.Value.Service,
                    TaskDefinition = latestTaskDefArn,
                    DesiredCount = desiredCount
                });

                SG_Common.Log(m_txtLog, $"‚úÖ ÏÑúÎπÑÏä§ {task.Value.Tag} ÏµúÏã† ÌÉúÏä§ÌÅ¨Î°ú {latestTaskDefArn}Î≥ÄÍ≤Ω Î∞è ÌÉúÏä§ÌÅ¨ {desiredCount}Í∞ú ÏÑ§Ï†ïÎê®");
            }
            m_bEditingCount = false;
        }
        
        // async void UpdateECS(bool bOn)
        // {
        //     var selectedTags = m_checkBoxPanel.Controls.OfType<TableLayoutPanel>()
        //         .SelectMany(panel => panel.Controls.OfType<CheckBox>())
        //         .Where(cb => cb.Checked)
        //         .Select(cb => cb.Text)
        //         .ToList();

        //     SG_Common.Log(m_txtLog, $"UpdateECS {selectedTags.Count}Í∞ú ÏÑ†ÌÉùÎê®");

        //     foreach (var task in m_dicecsData)
        //     {
        //         if (!selectedTags.Contains(task.Key.ToString())) continue;

        //         var taskDefs = await m_ecsClient.ListTaskDefinitionsAsync(new ListTaskDefinitionsRequest
        //         {
        //             FamilyPrefix = task.Value.Task,
        //             Sort = Amazon.ECS.SortOrder.DESC
        //         });

        //         var latestTaskDefArn = taskDefs.TaskDefinitionArns.FirstOrDefault();
        //         if (latestTaskDefArn == null)
        //         {
        //             MessageBox.Show("‚ùå ÏµúÏã† ÌÉúÏä§ÌÅ¨ Ï†ïÏùòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
        //             return;
        //         }

        //         while (task.Value.ServiceCount == -1)
        //         {
        //             SG_Common.Log(m_txtLog, $"UpdateECS ECS Count ÏÑ§Ï†ï ÎêòÏßÄ ÏïäÏïÑ ÎåÄÍ∏∞Ï§ë....");
        //             await System.Threading.Tasks.Task.Delay(2000); // 2Ï¥àÎßàÎã§ Í∞±Ïã†.
        //         }

        //         int desiredCount = bOn ? task.Value.ServiceCount : 0;
        //         await m_ecsClient.UpdateServiceAsync(new UpdateServiceRequest
        //         {
        //             Cluster = task.Value.Cluster,
        //             Service = task.Value.Service,
        //             TaskDefinition = latestTaskDefArn,
        //             DesiredCount = desiredCount
        //         });

        //         SG_Common.Log(m_txtLog, $"‚úÖ UpdateECS {task.Value.Tag} : ÌÉúÏä§ÌÅ¨Î°ú {latestTaskDefArn}Î≥ÄÍ≤Ω, ÏÑúÎπÑÏä§ {desiredCount}Í∞ú ÏÑ§Ï†ïÎê®");
        //     }
        // }
    }
}
